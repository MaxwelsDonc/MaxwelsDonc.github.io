name: Update github myprofile

on:
  page_build:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # 必须添加这个权限声明，否则 GITHUB_TOKEN 只有读权限
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v3

    - name: Install Reqs
      run: |
        sudo apt-get install -y python3-setuptools

    - name: Run
      run: |
        cd ./github_myprofile_updater
        python3 update.py
        
        # 这里的 git init 如果是为了在子目录重新构建仓库，可以保留
        # 但要注意 git add 的路径相对于当前执行位置
        git init
        git config --local user.name "${GITHUB_ACTOR}"
        git config --local user.email "zhouzenghui.p@qq.com"
        
        # 建议直接使用内置的 GITHUB_TOKEN，它比自定义 Secret 更稳定
        export remote_repo="https://${GITHUB_ACTOR}:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git"
        
        # 关键修改 1：使用 -f 强制添加被忽略的 README.md
        git add -f README.md

        git commit -m "update my description automatically"
        
        # 关键修改 2：确保推送到 main 分支
        git push "${remote_repo}" HEAD:main --force